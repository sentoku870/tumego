# ver3 Worklog（基盤整備フェーズ）

本ファイルは ver3 の作業ログ・決定事項・タスク管理に使用する。

## 0. フェーズ概要

- 目的:
  - ver2 までに蓄積した内部の歪み・分かりにくさを解消し、今後の機能追加（ヒントモード・分岐表示など）に耐えられる基盤を整える。
  - 新規機能の追加は原則行わず、「バグ修正」「内部構造の整理」「命名整理」「責務の分離」を中心とする。
- 対象範囲:
  - E1: 状態管理（GameStore / History / モード遷移 周り）
  - E2: UI コントローラ層（ToolbarController / BoardInteractionController / Settings 関連）
- 非対象（別フェーズで扱う）:
  - ヒントモードの本格実装、GoEngine との連携強化
  - 大規模な UI 再設計（スマホ縦レイアウトの全面見直し等）
  - 高度な SGF 編集機能

## 1. E1: 状態管理（GameStore / History / モード遷移）

### 1-1. Topic E1-1: Undo / History / モード遷移の整理

#### 背景

- 現状、以下の要素がそれぞれ歴史的経緯で追加されており、相互関係が分かりにくい。
  - `GameStore` 内の状態（`mode`, `numberMode`, `startColor`, `turn` など）
  - 1手単位の戻し処理（Undo）
  - モードの切り替え（編集 ⇔ 解答、SGF 読み込み など）
  - 履歴管理（History / HistoryManager / snapshot / sgfIndex など）
- 結果として、以下のような問題が発生しやすい:
  - 編集モードと解答モードをまたいだ Undo の挙動が直感的でない。
  - 「単純に 1 手戻したい」のか「大きく状態を巻き戻したい（読込直後に戻す等）」のかが、コード上で明確に分離されていない。
  - `mode` / `numberMode` / `startColor` / `sgfIndex` / `turn` 等の組み合わせの不変条件が整理されておらず、将来の変更に弱い。

#### 現状の整理（観察ベースで書き足していく）

※ここは実際の動作確認やコードリーディングに応じて、随時追記していく。

- 編集モード（edit）のとき:
  - 想定される操作:
    - 初期図の作成・修正
    - 問題図の上書き保存
    - SGF 読み込み後の軽微な修正
  - Undo の想定:
    - 直前の「石の追加・削除・マーク変更」などを 1 ステップ戻す。
    - 編集⇔解答のモード境界までは戻らない（モードの切り替えは History 側の責務とする予定）。

- 解答モード（solve）のとき:
  - 想定される操作:
    - 問題図からの着手（ユーザーの読み進め）
    - 黒番・白番の切り替えは「開始時の startColor＋着手数」から自動的に決まるのが理想。
  - Undo の想定:
    - 直前の「着手」を 1 手だけ戻す。
    - 問題図そのものや SGF のインデックスには影響を与えない。
    - 解答中に編集モードへ戻る操作は Undo ではなく「モード切替＋History」で扱う。

- History（大きな単位の巻き戻し）:
  - 想定:
    - 「SGF 読み込み直後に戻す」「編集開始前の状態に戻す」など、モード境界を含む大きな戻し。
    - Undo とは別レイヤーで管理する。
  - 実装:
    - `HistoryManager` や `snapshot` 関数などを用いて、GameStore の状態を丸ごと保存・復元する形が理想。
  

#### 現状の挙動（シナリオ別メモ）

- A1: 編集モードで石を 3 個置いてから Undo を 3 回実行
  - 操作:
    - 編集モードで黒→白→黒の順に石を 3 個配置。
  - 観察:
    - 石は問題なく 3 つ置けるが、Undo ボタンはグレーアウトのままで押せない。
  - メモ:
    - 編集モードでは、盤面変更をしても Undo がそもそも有効になっていない状態。

- A2: 編集モードで石を置いたあと、「解答開始 → Undo → 編集へ戻る」
  - 操作:
    - 編集モードで石を配置 → 「解答開始」ボタンを押す → 解答モードで Undo を押す。
  - 観察:
    - 「解答開始」ボタンを押すと Undo が押せるようになる。
    - 「黒先」ボタンも押せる。
    - 解答モードで Undo を押すと、「交互配置」に切り替わり、解答モードの手番はそのまま引き継がれる挙動になる。
  - メモ:
    - Undo を押したタイミングで「交互配置への切り替え＋手番維持」が同時に起きており、Undo が単なる「1 手戻す」動作になっていない。

- B1: 解答モードで 5 手打ってから Undo を 5 回実行
  - 操作:
    - 解答モードで石を 5 手分打つ → Undo を連打する。
  - 観察:
    - 解答モードで石は 5 回置ける。
    - Undo を 1 回押すと、置いた 5 手分の石がすべて消える。
    - その後、交互配置の手番は黒になる。
    - 2 回目以降の Undo はグレーアウトして押せない。
  - メモ:
    - 「1 手ずつ戻す」のではなく、「まとめて全消去＋手番リセット」になっている。

- B2: 解答中に SGF を読み込み直した場合
  - 操作:
    - 解答モードで着手している途中で SGF を読み込む。
  - 観察:
    - 解答中の石はすべて消える。
    - 読み込んだ棋譜の 1 手目が表示される。
    - 交互配置の手番は白番になる。
  - メモ:
    - SGF 読み込みが「盤面を SGF 側に完全リセットする」動きになっている。

- C1: SGF 読み込み直後に「元の問題に戻る」操作
  - 前提として想定したパターン:
    - (1) ブラウザリロード後に SGF を読み込む。
    - (2) 編集モードから問題図を確定させて SGF を読み込む。
    - (3) 解答モードで初期図がある状態で着手後に SGF を読み込む。
  - 観察:
    - いずれのケースでも、SGF 読み込み後は「読み込んだ SGF の状態」に統一される。
    - その状態から「元の問題図に戻る」ための明確な操作は存在しない。
  - メモ:
    - 「SGF 読み込み前の状態に History で戻る」ような仕組みは現状ない。

#### 暫定メモ（問題がありそうな点）

- A1:
  - 編集モードで盤面変更をしても Undo が有効にならない。
  - 「編集モードでは 1 ステップ戻せる」のが直感的と思われるので、現状は仕様かバグかを要確認。

- A2:
  - Undo を押したときに「交互配置への切り替え」や「手番維持」など、Undo 以外の状態変更が同時に起きている。
  - Undo が「単純な 1 手戻し」ではなく、「モード切替を引き起こすボタン」にもなってしまっている可能性。

- B1:
  - 解答モードでの Undo が「最後の 1 手」ではなく「すべての解答石をまとめて消す」動きになっている。
  - その後、手番が黒で固定され、Undo も 1 回しか使えないため、「連続して読みを試す」用途としては不便。

- B2:
  - 解答中に SGF を読み込むと、Undo では「SGF 読み込み前の状態」に戻れない。
  - これは仕様として許容するか、「大きな履歴（History）」で扱うかの整理が必要。

- C1:
  - SGF 読み込み前の問題図に戻る手段がない。
  - 新規機能追加の扱いになりやすいため、ver3 では「仕様としてそういうもの」と割り切るか、「最低限 History に snapshot を残す」か要検討。

#### 理想の挙動（シナリオ別・ver3 で目指すライン）

- A1: 編集モードで石を 3 個置いてから Undo を 3 回実行
  - ユーザー期待:
    - 盤面に対する「直前の編集操作」を 1 ステップずつ戻したい。
  - 理想挙動:
    - 編集モードで石やマークを配置・削除した時点で Undo が有効になる。
    - Undo を 1 回押すと、最後の編集操作だけが取り消される（石 1 個配置ならその石だけ消える）。
    - 取り消す編集がなくなった時点で Undo は自動的に無効（グレーアウト）になる。
    - `mode` / `numberMode` / `startColor` / `sgfIndex` / `turn` など「モードや手番」は変化しない。

- A2: 編集モードで石を置いたあと、「解答開始 → Undo → 編集へ戻る」
  - ユーザー期待:
    - 解答中の着手だけを 1 手ずつ戻したい。
    - Undo によって「配置モードやモード自体が勝手に変わる」ことは避けたい。
  - 理想挙動:
    - 編集モードから「解答開始」した時点で、問題図は固定され、解答モードの Undo 対象は「解答中の着手」のみになる。
    - 解答モードで Undo を押すと、直前の着手が 1 手だけ取り消される（盤上の石が 1 手分消え、手番も 1 手分戻る）。
    - Undo を何度も押せば、解答開始直後の盤面（問題図）まで 1 手ずつ戻る。
    - 問題図まで戻った状態では、それ以上 Undo を押せない（ボタンが無効になる）。
    - Undo を押したことで `numberMode` や「交互配置/黒配置/白配置」の設定が勝手に変わることはない。
    - 編集モードに戻る操作（ボタン）は Undo とは別の操作として扱う。

- B1: 解答モードで 5 手打ってから Undo を 5 回実行
  - ユーザー期待:
    - 読み直しのために、打った手を 1 手ずつ前後したい。
  - 理想挙動:
    - 解答モードでは、着手のたびに Undo で戻せる「解答用スタック」が積み上がる。
    - Undo を 1 回押すと、最後の 1 手だけが取り消される。
    - 5 手打ったあとなら、Undo を 5 回押すことで 5 手分が 1 手ずつ戻る。
    - すべて戻すと「問題図の盤面＋開始手番」に戻り、Undo ボタンは無効になる。
    - 手番（黒番/白番）は、`startColor` と「打たれた手数」から決まり、Undo で手数も 1 つ戻る。

- B2: 解答中に SGF を読み込み直した場合
  - ユーザー期待:
    - SGF 読み込みは「盤面を SGF 状態に切り替える大きな操作」であり、Undo の対象とは別物として扱ってよい。
  - 理想挙動（ver3 の現実的ライン）:
    - SGF を読み込んだ瞬間、盤面は「読み込んだ SGF の局面」にリセットされる。
    - 解答中に積まれていた Undo スタックはクリアされる（SGF 読み込み前の解答手には戻れない）。
    - SGF 読み込み直後の Undo は「SGF 内での 1 手戻し」のような新機能は提供しない（新規機能扱いのため ver3 では見送る）。
    - 「SGF 読み込み前の状態に戻る」動きは、将来的には History（大きな巻き戻し）側で検討する。

- C1: SGF 読み込み直後に「元の問題に戻る」操作
  - ユーザー期待:
    - 可能であれば、「SGF を試しに読み込んだだけなので、元の問題図に戻りたい」というニーズは存在しうる。
  - 理想挙動（将来案）:
    - SGF 読み込み前に、現在の GameStore 状態を History に snapshot として保存しておき、特別な操作でそこへ戻れる。
  - ver3 での扱い（スコープ線引き）:
    - ver3 では「SGF を読み込んだら、その状態が現在の基準になる」と割り切る。
    - 「元の問題図に戻る」専用操作を追加するのは、新規機能になるため ver4 以降の検討とする。
    - ただし、実装的に余裕があれば「SGF 読み込み前 snapshot を内部的に残す」程度は検討余地あり（UI に出さない範囲）。

#### E1-1-3: シナリオと関連コンポーネントの対応づけ（暫定）

※ここでは、アーキテクチャ概要に基づいた「どのレイヤ／クラスが関わっていそうか」の暫定マップを整理する。  
　具体的なメソッド名やフィールドは、後でコードを読みながら補完していく。

- A1: 編集モードで石を 3 個置いてから Undo を 3 回実行

  - 想定される流れ:
    - ユーザーが盤面をクリック → 石が置かれる（編集モード）。
    - 必要であれば Undo ボタンが有効になり、押すと「直前の編集操作」が 1 ステップ戻る想定。

  - 関連しそうなコンポーネント:
    - UI 層:
      - `BoardInteractionController`
        - 盤上クリックを受け取り、編集モードでは `GameStore` の「直接配置/削除系メソッド（directPlace/remove 相当）」を呼び出す。
      - `ToolbarController`
        - Undo ボタンの有効/無効状態を更新。
        - クリック時に `GameStore.undo()` 相当の処理を呼ぶ。
    - ロジック層:
      - `GameStore`
        - 編集モードの盤面変更（石の追加/削除）を扱う。
        - Undo 用のスタック（仮: `undoStack` など）や `GameState` の更新を行う。
      - `HistoryManager`（必要に応じて）
        - 編集モードでの「大きな巻き戻し」がある場合に関与する可能性。
    - 状態フィールド（例）:
      - `GameState.mode = "edit"`
      - `GameState.board` / `stones` / 盤面関連フィールド
      - `GameState.history` / `undoStack`（実コードで要確認）

- A2: 編集モードで石を置いたあと、「解答開始 → Undo → 編集へ戻る」

  - 想定される流れ:
    - 編集モードで盤面を編集 → 「解答開始」ボタン押下 → 解答モードへ遷移。
    - 解答モードで着手 → Undo により「解答中の着手のみ」が 1 手ずつ戻る。
    - 編集モードへ戻るのは、Undo とは別の操作。

  - 関連しそうなコンポーネント:
    - UI 層:
      - `ToolbarController`
        - 「解答開始」「編集へ戻る」「Undo」「黒先/白先/交互配置」ボタンを束ねており、それぞれ対応する `GameStore` のメソッドを呼び出す。
    - ロジック層:
      - `GameStore`
        - 編集モード → 解答モードへの遷移（例: `enterSolveMode()` のような処理）。
        - 解答中の着手処理（後述 B1 の `tryMove` 相当）と、解答用 Undo スタックの管理。
      - `HistoryManager`
        - モード切替前後で snapshot を取る場合に関与する可能性。
    - 状態フィールド（例）:
      - `GameState.mode`（"edit" ↔ "solve"）
      - `GameState.numberMode`（解答モードの番号表示）
      - `GameState.startColor` / `GameState.turn`
      - 解答用の手順リスト（仮: `answerMoves` など。実コードで要確認）

- B1: 解答モードで 5 手打ってから Undo を 5 回実行

  - 想定される流れ:
    - 解答モードで `BoardInteractionController` 経由で着手。
    - それぞれの着手は `GameStore.tryMove` のようなメソッドで処理され、Undo 用スタックに積まれる。
    - Undo ボタン押下で、直前の 1 手ずつが戻る。

  - 関連しそうなコンポーネント:
    - UI 層:
      - `BoardInteractionController`
        - 解答モード時は `GameStore.tryMove` を呼んで着手を処理する。
      - `ToolbarController`
        - Undo ボタンの有効/無効状態を、解答用スタックの有無に応じて制御。
    - ロジック層:
      - `GameStore`
        - 解答モードの着手処理（合法手チェック、石取り、手番更新など）。
        - 解答用 Undo スタックの push/pop。
      - `GoEngine`
        - 着手結果の盤面計算（合法性チェック・石の取り除きなど）。
    - 状態フィールド（例）:
      - 解答用の手順リスト or スタック。
      - `GameState.turn`（手番）、`GameState.startColor`
      - 盤面状態 `GameState.board`

- B2: 解答中に SGF を読み込み直した場合

  - 想定される流れ:
    - 解答モード中に SGF 読み込み操作。
    - 盤面と手番が SGF 側の状態に置き換わり、解答用 Undo スタックはリセットされる。

  - 関連しそうなコンポーネント:
    - UI 層:
      - `FileMenuController`（名称は要確認）
        - 「SGF 読込」ボタンなどを受け取り、`GameStore.loadFromSgf` 相当を呼び出す。
    - ロジック層:
      - `GameStore`
        - SGF のパース結果を `GameState` に適用。
        - 解答用 Undo スタックのクリア。
      - SGF 入出力関連モジュール
        - SGF → 内部表現への変換。
    - 状態フィールド（例）:
      - `GameState.sgfIndex` / SGF 内の局面位置
      - `GameState.board`, `GameState.turn`
      - Undo/History 関連フィールドのリセット

- C1: SGF 読み込み直後に「元の問題に戻る」操作

  - 想定される流れ:
    - SGF 読み込み前の状態を snapshot として保存しておき、何らかの手段でその snapshot へ戻る。
    - ver3 では UI まで出さないが、内部的な History として整理する候補。

  - 関連しそうなコンポーネント:
    - ロジック層:
      - `HistoryManager`
        - SGF 読み込み前の `GameState` snapshot を保持し、必要に応じて復元する役割の候補。
      - `GameStore`
        - snapshot の保存/復元を `HistoryManager` に委譲する窓口。

  - ver3 での扱い:
    - 「元の問題に戻る」専用操作は UI としては追加しない（新機能扱いのため）。
    - ただし、History の設計を整理する中で、将来的に snapshot を活用できるようにしておくことは検討対象。


#### 目標（Done の定義）

- ユーザー視点:
  - 編集モードでの Undo は「直前の編集操作を 1 ステップ戻す」ことに専念する。
  - 解答モードでの Undo は「直前の着手を 1 手戻す」ことに専念する。
  - 「編集⇔解答の切り替え」や「SGF 読み込み直後に戻す」といった大きな巻き戻しは、Undo ではなく「履歴（History）」で一貫して扱う。
- 実装視点:
  - `mode` / `numberMode` / `startColor` / `turn` / `sgfIndex` などの関係について、少なくとも以下が明文化されている:
    - 各モードにおいてどの組み合わせが有効か（不変条件）。
    - Undo が影響を与えてよいフィールド／与えてはいけないフィールド。
    - History（snapshot ベースの復元）が担当する範囲。
  - Undo と History の責務分離がコードコメントまたはドキュメントに反映されている。

#### 対応方針（高レベル）

1. まず「現状の挙動」を確認する:
   - 代表的なシナリオを整理し、実機で試して結果をメモする。
   - 同時に関連コード（GameStore / HistoryManager / ToolbarController など）を読み、どの関数がどのシナリオを処理しているか対応づける。

2. 次に「理想の挙動」をシナリオ単位で定義する:
   - 編集モードの Undo 挙動（シナリオ A 群）
   - 解答モードの Undo 挙動（シナリオ B 群）
   - History を使った大きな戻し（シナリオ C 群）

3. 最後に「差分を埋めるためのリファクタ計画」を作る:
   - フィールドの整理・命名変更（例: `history` と `undoStack` の役割分離など）。
   - モード境界での snapshot タイミングの統一。
   - Undo で触るべきでない処理を History 側に寄せる。

#### TODO リスト（E1-1）

- [x] E1-1-1: 代表シナリオの洗い出し
  - 例:
    - A1: 編集モードで石を 3 個置いてから Undo を 3 回実行。
    - A2: 編集モードで石を置いたあと、「解答開始 → Undo → 編集へ戻る」など。
    - B1: 解答モードで 5 手打ってから Undo を 5 回実行。
    - B2: 解答中に SGF を読み込み直した場合など。
    - C1: SGF 読み込み直後に「元の問題に戻る」操作がある場合 など。
- [x] E1-1-2: 上記シナリオごとに「現状の挙動」を記録（このファイルに追記）。
- [x] E1-1-3: 各シナリオと関連コード（関数・クラス）を対応づけるマップを作成。
- [x] E1-1-4: 各シナリオごとに「理想の挙動」をテキストで定義。
- [ ] E1-1-5: 差分を埋めるリファクタ案を作成し、別セクション（E1-1-RefactorPlan）として整理。
- [ ] E1-1-6: 実装フェーズ（Codex or GPT）に渡すための要約を作成。

#### メモ・決定事項

- ver3 では Undo/History の「仕様整理と最小限の修正」をゴールとし、  
  大規模な設計変更（例: 完全な状態マシン化）は ver4 以降に回す可能性がある。
- Undo の UI（ボタン配置・ラベル）は ver3 では原則変更しない。  
  挙動の一貫性とバグの解消を優先する。

---

## 2. E2: UI コントローラ層（ToolbarController / BoardInteractionController など）

※ここは今後のトピックを追加していくための雛形。

### 2-1. Topic E2-1: （未設定）

- 背景:
- 目標:
- TODO:

---

## 9. メモ（雑多なアイデア／ver4 以降候補）

- ver3 のスコープから外したアイデアや、将来やりたいことをメモしておく場所。
- 本格的に扱うことが決まったら、`docs/90-idea-backlog.md` 等に移動する。
