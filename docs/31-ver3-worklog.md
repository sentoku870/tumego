# ver3 Worklog（基盤整備フェーズ）

本ファイルは ver3 の作業ログ・決定事項・タスク管理に使用する。

## 0. フェーズ概要

- 目的:
  - ver2 までに蓄積した内部の歪み・分かりにくさを解消し、今後の機能追加（ヒントモード・分岐表示など）に耐えられる基盤を整える。
  - 新規機能の追加は原則行わず、「バグ修正」「内部構造の整理」「命名整理」「責務の分離」を中心とする。
- 対象範囲:
  - E1: 状態管理（GameStore / History / モード遷移 周り）
  - E2: UI コントローラ層（ToolbarController / BoardInteractionController / Settings 関連）
- 非対象（別フェーズで扱う）:
  - ヒントモードの本格実装、GoEngine との連携強化
  - 大規模な UI 再設計（スマホ縦レイアウトの全面見直し等）
  - 高度な SGF 編集機能

## 1. E1: 状態管理（GameStore / History / モード遷移）

### 1-1. Topic E1-1: Undo / History / モード遷移の整理

#### 背景

- 現状、以下の要素がそれぞれ歴史的経緯で追加されており、相互関係が分かりにくい。
  - `GameStore` 内の状態（`mode`, `numberMode`, `startColor`, `turn` など）
  - 1手単位の戻し処理（Undo）
  - モードの切り替え（編集 ⇔ 解答、SGF 読み込み など）
  - 履歴管理（History / HistoryManager / snapshot / sgfIndex など）
- 結果として、以下のような問題が発生しやすい:
  - 編集モードと解答モードをまたいだ Undo の挙動が直感的でない。
  - 「単純に 1 手戻したい」のか「大きく状態を巻き戻したい（読込直後に戻す等）」のかが、コード上で明確に分離されていない。
  - `mode` / `numberMode` / `startColor` / `sgfIndex` / `turn` 等の組み合わせの不変条件が整理されておらず、将来の変更に弱い。

#### 現状の整理（観察ベースで書き足していく）

※ここは実際の動作確認やコードリーディングに応じて、随時追記していく。

- 編集モード（edit）のとき:
  - 想定される操作:
    - 初期図の作成・修正
    - 問題図の上書き保存
    - SGF 読み込み後の軽微な修正
  - Undo の想定:
    - 直前の「石の追加・削除・マーク変更」などを 1 ステップ戻す。
    - 編集⇔解答のモード境界までは戻らない（モードの切り替えは History 側の責務とする予定）。

- 解答モード（solve）のとき:
  - 想定される操作:
    - 問題図からの着手（ユーザーの読み進め）
    - 黒番・白番の切り替えは「開始時の startColor＋着手数」から自動的に決まるのが理想。
  - Undo の想定:
    - 直前の「着手」を 1 手だけ戻す。
    - 問題図そのものや SGF のインデックスには影響を与えない。
    - 解答中に編集モードへ戻る操作は Undo ではなく「モード切替＋History」で扱う。

- History（大きな単位の巻き戻し）:
  - 想定:
    - 「SGF 読み込み直後に戻す」「編集開始前の状態に戻す」など、モード境界を含む大きな戻し。
    - Undo とは別レイヤーで管理する。
  - 実装:
    - `HistoryManager` や `snapshot` 関数などを用いて、GameStore の状態を丸ごと保存・復元する形が理想。

#### 目標（Done の定義）

- ユーザー視点:
  - 編集モードでの Undo は「直前の編集操作を 1 ステップ戻す」ことに専念する。
  - 解答モードでの Undo は「直前の着手を 1 手戻す」ことに専念する。
  - 「編集⇔解答の切り替え」や「SGF 読み込み直後に戻す」といった大きな巻き戻しは、Undo ではなく「履歴（History）」で一貫して扱う。
- 実装視点:
  - `mode` / `numberMode` / `startColor` / `turn` / `sgfIndex` などの関係について、少なくとも以下が明文化されている:
    - 各モードにおいてどの組み合わせが有効か（不変条件）。
    - Undo が影響を与えてよいフィールド／与えてはいけないフィールド。
    - History（snapshot ベースの復元）が担当する範囲。
  - Undo と History の責務分離がコードコメントまたはドキュメントに反映されている。

#### 対応方針（高レベル）

1. まず「現状の挙動」を確認する:
   - 代表的なシナリオを整理し、実機で試して結果をメモする。
   - 同時に関連コード（GameStore / HistoryManager / ToolbarController など）を読み、どの関数がどのシナリオを処理しているか対応づける。

2. 次に「理想の挙動」をシナリオ単位で定義する:
   - 編集モードの Undo 挙動（シナリオ A 群）
   - 解答モードの Undo 挙動（シナリオ B 群）
   - History を使った大きな戻し（シナリオ C 群）

3. 最後に「差分を埋めるためのリファクタ計画」を作る:
   - フィールドの整理・命名変更（例: `history` と `undoStack` の役割分離など）。
   - モード境界での snapshot タイミングの統一。
   - Undo で触るべきでない処理を History 側に寄せる。

#### TODO リスト（E1-1）

- [ ] E1-1-1: 代表シナリオの洗い出し
  - 例:
    - A1: 編集モードで石を 3 個置いてから Undo を 3 回実行。
    - A2: 編集モードで石を置いたあと、「解答開始 → Undo → 編集へ戻る」など。
    - B1: 解答モードで 5 手打ってから Undo を 5 回実行。
    - B2: 解答中に SGF を読み込み直した場合など。
    - C1: SGF 読み込み直後に「元の問題に戻る」操作がある場合 など。
- [ ] E1-1-2: 上記シナリオごとに「現状の挙動」を記録（このファイルに追記）。
- [ ] E1-1-3: 各シナリオと関連コード（関数・クラス）を対応づけるマップを作成。
- [ ] E1-1-4: 各シナリオごとに「理想の挙動」をテキストで定義。
- [ ] E1-1-5: 差分を埋めるリファクタ案を作成し、別セクション（E1-1-RefactorPlan）として整理。
- [ ] E1-1-6: 実装フェーズ（Codex or GPT）に渡すための要約を作成。

#### メモ・決定事項

- ver3 では Undo/History の「仕様整理と最小限の修正」をゴールとし、  
  大規模な設計変更（例: 完全な状態マシン化）は ver4 以降に回す可能性がある。
- Undo の UI（ボタン配置・ラベル）は ver3 では原則変更しない。  
  挙動の一貫性とバグの解消を優先する。

---

## 2. E2: UI コントローラ層（ToolbarController / BoardInteractionController など）

※ここは今後のトピックを追加していくための雛形。

### 2-1. Topic E2-1: （未設定）

- 背景:
- 目標:
- TODO:

---

## 9. メモ（雑多なアイデア／ver4 以降候補）

- ver3 のスコープから外したアイデアや、将来やりたいことをメモしておく場所。
- 本格的に扱うことが決まったら、`docs/90-idea-backlog.md` 等に移動する。
